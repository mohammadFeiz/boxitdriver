import { SplitNumber } from "aio-utils";
import { FC, useEffect, useState } from "react";
import { Splitter } from "./splitter";
import FooterButtons from "./footer-buttons";
import { I_consignment } from "../types";
import { useAppContext } from "../context";
import { I_usePopup } from "aio-popup";

const CodePaymentModal: FC<{ cods: I_consignment[], onPaymentSuccess: () => void, onFailedDelivery: () => void, popup: I_usePopup }> = ({ cods, onPaymentSuccess, onFailedDelivery, popup }) => {
    const { apis } = useAppContext()
    const [amounts, setAmounts] = useState<{ product: number, send: number, total: number }>({ product: 0, send: 0, total: 0 })
    const getAmounts = async () => {
        const amounts = await apis.getCODsAmounts(cods)
        setAmounts(amounts)
    }
    useEffect(() => {
        getAmounts()
    }, [])
    const payment = async () => {
        const res = await apis.codsPayment(cods)
        if (res) {
            popup.addModal({
                header: () => null,
                body: (
                    <CODPaymentSuccessModal
                        onClose={() => {
                            onPaymentSuccess();
                            popup.removeModal()
                        }}
                    />
                )
            })
        }
        else {
            popup.addModal({
                header: () => null,
                body: (
                    <CODPaymentFailedModal
                        onRetry={() => {
                            popup.removeModal();
                            payment()
                        }}
                        onCansel={() => {
                            popup.removeModal();
                            onFailedDelivery()
                        }}
                    />
                )
            })
        }
    }
    const failed = () => {
        popup.removeModal()
        onFailedDelivery()
    }
    const unit = 'تومان'
    const row_layout = (text: string, amount: number) => {
        return (
            <div className="flex-row- align-v- fs-12- gap-4-">
                <div className="">{text}</div>
                <div className="">{`(${unit})`}</div>
                <div className="">:</div>
                <div className="flex-1-"></div>
                <div className="bold-">{SplitNumber(amount)}</div>
            </div>
        )
    }
    return (
        <div className="flex-col- h-fit-">
            <div className="flex-col- border-panel m-12- gap-24-">
                {row_layout('هزینه کالا', amounts.product)}
                {row_layout('هزینه ارسال', amounts.send)}
                <Splitter dashed={true} />
                {row_layout('مجموع مبلغ قابل پرداخت', amounts.total)}
            </div>
            <FooterButtons
                trueText="پرداخت"
                canselText="عدم تحویل"
                trueAttrs={{
                    onClick: payment
                }}
                canselAttrs={{
                    onClick: failed
                }}
            />
        </div>
    )
}
export default CodePaymentModal


const CODPaymentFailedModal: FC<{ onRetry: () => void, onCansel: () => void }> = ({ onRetry, onCansel }) => {
    return (
        <div className="flex-col- h-100-">
            <div className="flex-col- flex-1- align-vh- gap-12-">
                <div className="flex-1-"></div>
                <div className="flex-row- align-vh-">
                    <FailedIcon />
                </div>
                <div className="fs-18- bold-">پرداخت ناموفق</div>
                <div className="fs-16-">پرداخت شما ناموفق بود!</div>
                <div className="flex-1-"></div>
            </div>
            <FooterButtons
                trueText='تلاش مجدد'
                canselText='لغو'
                trueAttrs={{
                    onClick: onRetry
                }}
                canselAttrs={{
                    onClick: onCansel
                }}
            />
        </div>
    )
}

const CODPaymentSuccessModal: FC<{ onClose: () => void }> = ({ onClose }) => {
    return (
        <div className="flex-col- h-100-">
            <div className="flex-col- flex-1- align-vh- gap-12-">
                <div className="flex-1-"></div>
                <div className="flex-row- align-vh- m-b-36-">
                    <SuccessIcon />
                </div>
                <div className="fs-18- bold-">پرداخت موفق</div>
                <div className="fs-16-">پرداخت شما با موفقیت انجام شد</div>
                <div className="flex-1-"></div>
            </div>
            <FooterButtons
                trueText='بازگشت'
                canselText=""
                trueAttrs={{
                    onClick: () => onClose()
                }}
            />
        </div>
    )
}

const FailedIcon: FC = () => {
    return (
        <svg width="308" height="205" viewBox="0 0 308 205" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g clipPath="url(#clip0_4127_14927)">
                <path fillRule="evenodd" clipRule="evenodd" d="M193.125 156.485H104.88C99.6467 156.485 95.4038 151.784 95.4038 145.986C95.4038 140.187 99.6467 135.487 104.88 135.487H138.151C141.886 135.487 144.915 132.133 144.916 127.995L144.917 127.641C144.918 123.692 142.029 120.488 138.464 120.488H138.174C128.774 120.488 121.192 112.003 121.318 101.59C121.335 100.187 121.335 98.784 121.319 97.3801C121.198 86.9709 128.777 78.4921 138.144 78.4921H179.101C183.291 78.4921 186.686 74.7297 186.686 70.0885C186.686 62.8957 191.949 57.0655 198.441 57.0655H207.423C213.914 57.0655 219.177 62.8957 219.177 70.0885V93.8001C219.177 100.493 224.074 105.918 230.114 105.918H235.422C243.753 105.918 250.507 113.401 250.507 122.631C250.507 131.861 243.753 139.344 235.422 139.344H207.966C204.138 139.344 201.151 142.811 201.26 147.05C201.261 147.126 201.263 147.203 201.265 147.279C201.377 152.332 197.688 156.485 193.125 156.485Z" fill="url(#paint0_linear_4127_14927)" />
                <path fillRule="evenodd" clipRule="evenodd" d="M110.965 48.2071H203.043C208.504 48.2071 212.931 53.1257 212.931 59.1934C212.931 65.261 208.504 70.1797 203.043 70.1797H168.327C164.43 70.1797 161.27 73.6889 161.268 78.0189L161.268 78.3899C161.266 82.5224 164.281 85.8745 168.001 85.8745H168.302C178.112 85.8745 186.023 94.7534 185.891 105.65C185.873 107.118 185.873 108.587 185.89 110.055C186.017 120.947 178.108 129.82 168.334 129.82H125.599C121.227 129.82 117.684 133.757 117.684 138.613C117.684 146.14 112.193 152.241 105.419 152.241H96.047C89.2734 152.241 83.7821 146.14 83.7821 138.613V113.801C83.7821 106.798 78.6724 101.121 72.3693 101.121H66.8315C58.1387 101.121 51.0913 93.291 51.0913 83.6325C51.0913 73.9739 58.1387 66.1439 66.8315 66.1439H95.4792C99.4737 66.1439 102.591 62.5161 102.478 58.0799L102.472 57.84C102.355 52.5528 106.205 48.2071 110.965 48.2071Z" fill="url(#paint1_linear_4127_14927)" />
                <path d="M198.631 110.885C202.891 118.804 200.511 130.606 200.511 130.606C200.511 130.606 187.905 126.841 183.645 118.915C179.385 110.99 179.287 102.775 183.429 100.559C187.565 98.3429 194.372 102.966 198.631 110.885ZM76.7079 153.096C78.8204 151.251 79.4234 147.548 79.4234 147.548C79.4234 147.548 75.3294 147.268 73.2172 149.113C71.1047 150.957 70.1725 153.344 71.1368 154.445C72.1016 155.545 74.5947 154.942 76.7079 153.096ZM217.286 41.2501C215.034 42.9212 214.138 46.5654 214.138 46.5654C214.138 46.5654 218.197 47.1688 220.449 45.4977C222.702 43.8263 223.821 41.52 222.947 40.3464C222.073 39.1731 219.54 39.577 217.286 41.2501Z" fill="#CCCCCC" />
                <path d="M108.996 163.081C110.409 161.724 112.613 161.724 113.92 163.08C115.226 164.437 115.14 166.636 113.727 167.993C112.314 169.349 110.109 169.349 108.803 167.993C107.496 166.637 107.583 164.437 108.996 163.081Z" fill="#FF3B30" />
                <path d="M240.259 76.6489C237.595 76.5969 235.475 74.4813 235.526 71.9236C235.576 69.3659 237.776 67.3347 240.441 67.3868C243.105 67.4388 245.224 69.5544 245.174 72.1121C245.124 74.6698 242.924 76.701 240.259 76.6489Z" fill="#FF3B30" />
                <path d="M71.5911 131.573C70.6307 132.495 70.6008 134.019 71.5244 134.978C72.448 135.937 73.9753 135.967 74.9357 135.045C75.8962 134.123 75.9261 132.598 75.0025 131.639C74.0789 130.68 72.5516 130.65 71.5911 131.573Z" fill="#CCCCCC" />
                <path d="M213.04 60.6589C214.207 60.0164 214.631 58.5512 213.987 57.3864C213.344 56.2215 211.876 55.798 210.709 56.4405C209.543 57.083 209.118 58.5481 209.762 59.713C210.405 60.8779 211.873 61.3014 213.04 60.6589Z" fill="#CCCCCC" />
                <path d="M240.141 115.887C241.473 115.913 242.574 114.856 242.6 113.526C242.627 112.196 241.568 111.097 240.235 111.071C238.903 111.045 237.802 112.102 237.776 113.432C237.75 114.762 238.809 115.861 240.141 115.887Z" fill="#CCCCCC" />
                <path d="M64.9176 79.5669C67.705 78.032 71.2109 79.0437 72.7482 81.8265C74.2856 84.6093 73.2723 88.1095 70.4849 89.6444C67.6976 91.1793 64.1917 90.1676 62.6543 87.3848C61.117 84.602 62.1303 81.1018 64.9176 79.5669Z" fill="#FF3B30" />
                <path d="M88.2173 47.2376C89.538 46.5103 91.1991 46.9897 91.9276 48.3082C92.656 49.6267 92.1759 51.2852 90.8552 52.0124C89.5345 52.7397 87.8734 52.2603 87.1449 50.9418C86.4165 49.6232 86.8966 47.9648 88.2173 47.2376Z" fill="#CCCCCC" />
                <path d="M214.543 159.337C211.556 158.475 209.835 155.359 210.698 152.378C211.561 149.396 214.682 147.678 217.669 148.539C220.655 149.401 222.376 152.517 221.513 155.498C220.65 158.48 217.529 160.199 214.543 159.337Z" fill="#FF3B30" />
                <path fillRule="evenodd" clipRule="evenodd" d="M93.0781 118.069V85.8082C93.0781 74.9552 98.8596 64.9218 108.251 59.4613L138.787 41.7185C143.451 39.0097 148.75 37.5826 154.146 37.5826C159.542 37.5826 164.842 39.0097 169.506 41.7185L200.041 59.4613C209.44 64.9218 215.221 74.9552 215.221 85.8082V118.069C215.221 128.922 209.44 138.955 200.048 144.416L169.512 162.159C164.848 164.868 159.549 166.295 154.153 166.295C148.757 166.295 143.458 164.868 138.794 162.159L108.258 144.416C98.8596 138.955 93.0781 128.922 93.0781 118.069Z" fill="#FF3B30" />
                <path d="M154.15 101.939V71.4528M154.143 125.65C153.206 125.65 152.446 126.409 152.453 127.344C152.453 127.793 152.632 128.224 152.95 128.541C153.268 128.859 153.7 129.037 154.15 129.038C154.599 129.037 155.031 128.859 155.349 128.541C155.667 128.224 155.846 127.793 155.846 127.344C155.846 127.121 155.801 126.9 155.716 126.695C155.63 126.489 155.504 126.302 155.346 126.145C155.188 125.987 155 125.863 154.794 125.778C154.587 125.693 154.366 125.65 154.143 125.65Z" stroke="white" strokeWidth="12.74" strokeLinecap="round" strokeLinejoin="round" />
                <path d="M241.78 95.9031L238.123 92.252L241.78 88.601L245.437 92.252L241.78 95.9031ZM185.67 42.5522L182.013 38.9015L185.67 35.2504L189.327 38.9015L185.67 42.5522ZM70.8821 115.491L67.2251 111.84L70.8821 108.189L74.5387 111.84L70.8821 115.491Z" stroke="#CCCCCC" strokeWidth="5.673" strokeLinecap="round" strokeLinejoin="round" />
            </g>
            <defs>
                <linearGradient id="paint0_linear_4127_14927" x1="169.648" y1="1.32531" x2="171.613" y2="264.657" gradientUnits="userSpaceOnUse">
                    <stop stop-color="white" />
                    <stop offset="1" stop-color="#EEEEEE" />
                </linearGradient>
                <linearGradient id="paint1_linear_4127_14927" x1="135.462" y1="210.568" x2="133.399" y2="-64.9861" gradientUnits="userSpaceOnUse">
                    <stop stop-color="white" />
                    <stop offset="1" stop-color="#EEEEEE" />
                </linearGradient>
                <clipPath id="clip0_4127_14927">
                    <rect width="308" height="205" fill="white" />
                </clipPath>
            </defs>
        </svg>
    )
}
const SuccessIcon: FC = () => {
    return (
        <svg width="309" height="205" viewBox="0 0 309 205" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g clipPath="url(#clip0_4127_14943)">
                <path d="M80.2379 116.333C76.8622 90.6838 94.649 60.1819 132.554 64.808C164.705 68.731 171.675 63.6727 185.516 56.4645C194.657 51.7065 208.956 43.2875 220.556 67.362C235.74 98.8712 200.132 148.275 168.329 163.427C137.918 177.918 86.3609 162.88 80.2379 116.333Z" fill="#34C759" />
                <path d="M83.9258 70.705L93.7764 60.9022C94.135 60.5453 94.135 59.9666 93.7764 59.6097C93.4177 59.2528 92.8362 59.2528 92.4775 59.6097L82.627 69.4124C82.2683 69.7693 82.2683 70.348 82.627 70.705C82.9857 71.0619 83.5672 71.0619 83.9258 70.705Z" fill="#CCCCCC" />
                <path d="M80.7937 160.222L86.6462 154.398C86.8594 154.186 86.8595 153.842 86.6463 153.63C86.4332 153.418 86.0876 153.418 85.8744 153.63L80.0219 159.454C79.8087 159.667 79.8087 160.01 80.0218 160.223C80.2349 160.435 80.5805 160.435 80.7937 160.222Z" fill="#CCCCCC" />
                <path d="M226.024 133.12L220.172 138.944C219.958 139.156 219.958 139.5 220.172 139.712C220.385 139.924 220.73 139.924 220.943 139.712L226.796 133.888C227.009 133.676 227.009 133.332 226.796 133.12C226.583 132.908 226.237 132.908 226.024 133.12Z" fill="#CCCCCC" />
                <path d="M84.89 63.6863L87.731 60.8592C88.0896 60.5022 88.0896 59.9235 87.731 59.5666C87.3723 59.2097 86.7908 59.2097 86.4321 59.5666L83.5912 62.3938C83.2325 62.7507 83.2325 63.3294 83.5912 63.6863C83.9498 64.0432 84.5314 64.0432 84.89 63.6863Z" fill="#CCCCCC" />
                <path d="M81.3667 156.052L83.0544 154.373C83.2676 154.161 83.2677 153.817 83.0545 153.605C82.8414 153.392 82.4958 153.392 82.2826 153.605L80.5949 155.284C80.3817 155.496 80.3816 155.84 80.5948 156.052C80.8079 156.264 81.1535 156.264 81.3667 156.052Z" fill="#CCCCCC" />
                <path d="M225.451 137.29L223.763 138.97C223.55 139.182 223.55 139.526 223.763 139.738C223.976 139.95 224.322 139.95 224.535 139.738L226.223 138.058C226.436 137.846 226.436 137.502 226.223 137.29C226.01 137.078 225.664 137.078 225.451 137.29Z" fill="#CCCCCC" />
                <path d="M167.585 171.01C166.015 171.384 163.905 172.19 162.709 173.795C161.513 175.4 162.96 175.874 164.871 175.565C166.781 175.257 168.677 174.185 169.446 172.675C170.214 171.165 168.874 170.703 167.585 171.01ZM175.322 168.022C174.563 168.203 173.545 168.592 172.966 169.367C172.389 170.142 173.088 170.371 174.01 170.222C174.933 170.073 175.849 169.555 176.22 168.826C176.592 168.096 175.944 167.874 175.322 168.022ZM203.564 157.625C205.536 156.279 205.729 153.147 205.729 153.147C205.729 153.147 202.725 152.198 200.754 153.545C198.782 154.89 198.588 158.021 198.588 158.021C198.588 158.021 201.592 158.97 203.564 157.625Z" fill="#CCCCCC" />
                <path d="M198.231 42.8193C199.683 42.8193 200.86 41.5644 200.86 40.0163C200.86 38.4682 199.683 37.2133 198.231 37.2133C196.779 37.2133 195.602 38.4682 195.602 40.0163C195.602 41.5644 196.779 42.8193 198.231 42.8193Z" fill="#CCCCCC" />
                <path d="M235.038 115.329C235.867 115.329 236.54 114.324 236.54 113.086C236.54 111.847 235.867 110.843 235.038 110.843C234.208 110.843 233.535 111.847 233.535 113.086C233.535 114.324 234.208 115.329 235.038 115.329Z" fill="#CCCCCC" />
                <path d="M123.866 114.419L140.388 131.026L176.448 94.7719" stroke="white" strokeWidth="10.94" strokeLinecap="round" strokeLinejoin="round" />
                <path d="M166.75 57.015C156.009 59.845 144.338 51.0222 144.338 51.0222C144.338 51.0222 150.089 37.6152 160.833 34.793C171.574 31.963 183.242 40.7783 183.242 40.7783C183.242 40.7783 177.491 54.185 166.75 57.015Z" fill="url(#paint0_linear_4127_14943)" />
                <path d="M241.413 84.1034C238.183 87.3745 232.144 86.685 232.144 86.685C232.144 86.685 231.345 80.6915 234.577 77.4221C237.807 74.1509 243.843 74.8387 243.843 74.8387C243.843 74.8387 244.643 80.8322 241.413 84.1034Z" fill="url(#paint1_linear_4127_14943)" />
                <path d="M68.0924 108.6C71.1002 108.6 73.5384 111.194 73.5384 114.394C73.5384 117.593 71.1002 120.187 68.0924 120.187C65.0847 120.187 62.6465 117.593 62.6465 114.394C62.6465 111.194 65.0847 108.6 68.0924 108.6Z" fill="#CCCCCC" />
                <path d="M66.9657 82.4377C68.1067 82.4377 69.0316 81.6009 69.0316 80.5687C69.0316 79.5366 68.1067 78.6998 66.9657 78.6998C65.8248 78.6998 64.8999 79.5366 64.8999 80.5687C64.8999 81.6009 65.8248 82.4377 66.9657 82.4377Z" fill="#CCCCCC" />
                <path d="M120.298 56.2745C122.476 56.2745 124.242 54.5175 124.242 52.3502C124.242 50.1828 122.476 48.4258 120.298 48.4258C118.12 48.4258 116.354 50.1828 116.354 52.3502C116.354 54.5175 118.12 56.2745 120.298 56.2745Z" fill="#CCCCCC" />
                <path d="M231.135 46.9307H231.056C230.587 53.5962 225.648 53.6987 225.648 53.6987C225.648 53.6987 231.094 53.8053 231.094 61.5072C231.094 53.8053 236.54 53.6987 236.54 53.6987C236.54 53.6987 231.604 53.5962 231.135 46.9307Z" fill="#CCCCCC" />
            </g>
            <defs>
                <linearGradient id="paint0_linear_4127_14943" x1="126.217" y1="64.4124" x2="219.473" y2="17.0968" gradientUnits="userSpaceOnUse">
                    <stop stop-color="white" />
                    <stop offset="1" stop-color="#EEEEEE" />
                </linearGradient>
                <linearGradient id="paint1_linear_4127_14943" x1="228.527" y1="95.2772" x2="251.715" y2="58.7508" gradientUnits="userSpaceOnUse">
                    <stop stop-color="white" />
                    <stop offset="1" stop-color="#EEEEEE" />
                </linearGradient>
                <clipPath id="clip0_4127_14943">
                    <rect width="309" height="205" fill="white" />
                </clipPath>
            </defs>
        </svg>

    )
}